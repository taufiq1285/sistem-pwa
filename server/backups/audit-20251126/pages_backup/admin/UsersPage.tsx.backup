import { useState, useEffect } from 'react';
import { Users, UserPlus, Search, RefreshCw, Shield, CheckCircle, XCircle, Edit } from 'lucide-react';
import { toast } from 'sonner';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Label } from '@/components/ui/label';
import { getAllUsers, getUserStats, toggleUserStatus, updateUser, type SystemUser, type UserStats, type UpdateUserData } from '@/lib/api/users.api';

const ROLE_BADGE = { admin: 'default' as const, dosen: 'secondary' as const, mahasiswa: 'outline' as const, laboran: 'destructive' as const };

export default function UsersPage() {
  const [users, setUsers] = useState<SystemUser[]>([]);
  const [stats, setStats] = useState<UserStats>({ total: 0, admin: 0, dosen: 0, mahasiswa: 0, laboran: 0, active: 0, inactive: 0 });
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [roleFilter, setRoleFilter] = useState('all');
  const [editingUser, setEditingUser] = useState<SystemUser | null>(null);
  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);
  const [formData, setFormData] = useState<UpdateUserData>({});

  useEffect(() => { loadUsers(); }, []);

  const loadUsers = async () => {
    try {
      setLoading(true);
      const [usersData, statsData] = await Promise.all([getAllUsers(), getUserStats()]);
      setUsers(usersData);
      setStats(statsData);
    } catch (error) {
      toast.error('Gagal memuat data users');
      console.error(error);
    } finally {
      setLoading(false);
    }
  };

  const handleToggle = async (userId: string, currentStatus: boolean) => {
    try {
      await toggleUserStatus(userId, !currentStatus);
      toast.success('Status updated');
      await loadUsers();
    } catch (error) {
      toast.error('Gagal mengubah status');
    }
  };

  const handleEdit = (user: SystemUser) => {
    setEditingUser(user);
    setFormData({ email: user.email, full_name: user.full_name, role: user.role, is_active: user.is_active });
    setIsEditDialogOpen(true);
  };

  const handleUpdate = async () => {
    if (!editingUser) return;
    try {
      await updateUser(editingUser.id, formData);
      toast.success('User updated successfully');
      setIsEditDialogOpen(false);
      await loadUsers();
    } catch (error) {
      toast.error('Failed to update user');
      console.error(error);
    }
  };

  const filteredUsers = users.filter(u => {
    const match = u.email.toLowerCase().includes(searchQuery.toLowerCase()) || u.full_name.toLowerCase().includes(searchQuery.toLowerCase()) || (u.nim && u.nim.includes(searchQuery)) || (u.nip && u.nip.includes(searchQuery));
    const role = roleFilter === 'all' || u.role === roleFilter;
    return match && role;
  });

  return (<div className="container mx-auto py-6 max-w-7xl space-y-6"><div className="flex items-center justify-between"><div><h1 className="text-3xl font-bold">User Management</h1><p className="text-muted-foreground">Manage all system users</p></div><div className="flex gap-2"><Button variant="outline" onClick={loadUsers}><RefreshCw className="h-4 w-4 mr-2" />Refresh</Button><Button onClick={() => toast.info('Add user')}><UserPlus className="h-4 w-4 mr-2" />Add User</Button></div></div><div className="grid gap-4 md:grid-cols-5"><Card><CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2"><CardTitle className="text-sm font-medium">Total</CardTitle><Users className="h-4 w-4 text-muted-foreground" /></CardHeader><CardContent><div className="text-2xl font-bold">{stats.total}</div><p className="text-xs text-muted-foreground">{stats.active} active</p></CardContent></Card><Card><CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2"><CardTitle className="text-sm font-medium">Admin</CardTitle><Shield className="h-4 w-4" /></CardHeader><CardContent><div className="text-2xl font-bold">{stats.admin}</div></CardContent></Card><Card><CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2"><CardTitle className="text-sm font-medium">Dosen</CardTitle><Badge variant="secondary">Dosen</Badge></CardHeader><CardContent><div className="text-2xl font-bold">{stats.dosen}</div></CardContent></Card><Card><CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2"><CardTitle className="text-sm font-medium">Mahasiswa</CardTitle><Badge variant="outline">Mhs</Badge></CardHeader><CardContent><div className="text-2xl font-bold">{stats.mahasiswa}</div></CardContent></Card><Card><CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2"><CardTitle className="text-sm font-medium">Laboran</CardTitle><Badge variant="destructive">Lab</Badge></CardHeader><CardContent><div className="text-2xl font-bold">{stats.laboran}</div></CardContent></Card></div><div className="flex gap-4"><div className="flex-1 relative"><Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" /><Input placeholder="Search..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="pl-9" /></div><Select value={roleFilter} onValueChange={setRoleFilter}><SelectTrigger className="w-[180px]"><SelectValue /></SelectTrigger><SelectContent><SelectItem value="all">All</SelectItem><SelectItem value="admin">Admin</SelectItem><SelectItem value="dosen">Dosen</SelectItem><SelectItem value="mahasiswa">Mahasiswa</SelectItem><SelectItem value="laboran">Laboran</SelectItem></SelectContent></Select></div><Card><CardHeader><CardTitle>System Users</CardTitle><CardDescription>Manage user accounts</CardDescription></CardHeader><CardContent>{loading ? <div className="text-center py-12"><RefreshCw className="h-8 w-8 animate-spin mx-auto text-muted-foreground" /></div> : filteredUsers.length === 0 ? <div className="text-center py-12"><Users className="h-12 w-12 mx-auto text-muted-foreground mb-4" /><p>No users found</p></div> : <Table><TableHeader><TableRow><TableHead>Name</TableHead><TableHead>Email</TableHead><TableHead>Role</TableHead><TableHead>ID</TableHead><TableHead>Status</TableHead><TableHead>Action</TableHead></TableRow></TableHeader><TableBody>{filteredUsers.map(u => <TableRow key={u.id}><TableCell className="font-medium">{u.full_name}</TableCell><TableCell>{u.email}</TableCell><TableCell><Badge variant={ROLE_BADGE[u.role]}>{u.role}</Badge></TableCell><TableCell className="font-mono text-sm">{u.nim || u.nip || u.nidn || '-'}</TableCell><TableCell><Button variant="ghost" size="sm" onClick={() => handleToggle(u.id, u.is_active)}>{u.is_active ? <CheckCircle className="h-4 w-4 text-green-600 mr-1" /> : <XCircle className="h-4 w-4 text-red-600 mr-1" />}{u.is_active ? 'Active' : 'Inactive'}</Button></TableCell><TableCell><Button variant="outline" size="sm" onClick={() => handleEdit(u)}><Edit className="h-4 w-4 mr-1" />Edit</Button></TableCell></TableRow>)}</TableBody></Table>}</CardContent></Card><Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}><DialogContent className="max-w-md"><DialogHeader><DialogTitle>Edit User</DialogTitle><DialogDescription>Update user information</DialogDescription></DialogHeader><div className="space-y-4"><div><Label htmlFor="full_name">Full Name</Label><Input id="full_name" value={formData.full_name || ''} onChange={(e) => setFormData({...formData, full_name: e.target.value})} /></div><div><Label htmlFor="email">Email</Label><Input id="email" type="email" value={formData.email || ''} onChange={(e) => setFormData({...formData, email: e.target.value})} /></div><div><Label htmlFor="role">Role</Label><Select value={formData.role} onValueChange={(value: any) => setFormData({...formData, role: value})}><SelectTrigger><SelectValue /></SelectTrigger><SelectContent><SelectItem value="admin">Admin</SelectItem><SelectItem value="dosen">Dosen</SelectItem><SelectItem value="mahasiswa">Mahasiswa</SelectItem><SelectItem value="laboran">Laboran</SelectItem></SelectContent></Select></div><div className="flex items-center gap-2"><input type="checkbox" id="is_active_edit" checked={formData.is_active ?? true} onChange={(e) => setFormData({...formData, is_active: e.target.checked})} /><Label htmlFor="is_active_edit">Active</Label></div><div className="flex justify-end gap-2"><Button variant="outline" onClick={() => setIsEditDialogOpen(false)}>Cancel</Button><Button onClick={handleUpdate}>Save Changes</Button></div></div></DialogContent></Dialog></div>);
}
