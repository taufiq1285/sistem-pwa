/**
 * Laboratories Management Page for Admin
 * CRUD for managing all laboratories
 */
import { useState, useEffect } from 'react';
import { Building2, Plus, Search, MapPin, Users, Edit } from 'lucide-react';
import { toast } from 'sonner';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Label } from '@/components/ui/label';
import { getLaboratoriumList, updateLaboratorium, type Laboratorium, type UpdateLaboratoriumData } from '@/lib/api/laboran.api';

export default function LaboratoriesPage() {
  const [laboratories, setLaboratories] = useState<Laboratorium[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [editingLab, setEditingLab] = useState<Laboratorium | null>(null);
  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);
  const [formData, setFormData] = useState<UpdateLaboratoriumData>({});

  useEffect(() => { loadLaboratories(); }, [searchQuery]);

  const loadLaboratories = async () => {
    try {
      setLoading(true);
      const data = await getLaboratoriumList({ search: searchQuery || undefined });
      setLaboratories(data);
    } catch (error) {
      toast.error('Failed to load laboratories');
      console.error(error);
    } finally { setLoading(false); }
  };

  const handleEdit = (lab: Laboratorium) => {
    setEditingLab(lab);
    setFormData({ kode_lab: lab.kode_lab, nama_lab: lab.nama_lab, kapasitas: lab.kapasitas || undefined, lokasi: lab.lokasi || undefined, is_active: lab.is_active ?? true, keterangan: lab.keterangan || undefined });
    setIsEditDialogOpen(true);
  };

  const handleUpdate = async () => {
    if (!editingLab) return;
    try {
      await updateLaboratorium(editingLab.id, formData);
      toast.success('Laboratory updated successfully');
      setIsEditDialogOpen(false);
      await loadLaboratories();
    } catch (error) {
      toast.error('Failed to update laboratory');
      console.error(error);
    }
  };

  return (<div className="container mx-auto py-6 max-w-7xl space-y-6"><div className="flex items-center justify-between"><div><h1 className="text-3xl font-bold">Laboratories Management</h1><p className="text-muted-foreground">Manage all laboratory facilities</p></div><Button onClick={() => toast.info('Add laboratory feature')}><Plus className="h-4 w-4 mr-2" />Add Laboratory</Button></div><div className="grid gap-4 md:grid-cols-3"><Card><CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2"><CardTitle className="text-sm font-medium">Total Labs</CardTitle><Building2 className="h-4 w-4 text-muted-foreground" /></CardHeader><CardContent><div className="text-2xl font-bold">{laboratories.length}</div></CardContent></Card><Card><CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2"><CardTitle className="text-sm font-medium">Total Capacity</CardTitle><Users className="h-4 w-4 text-muted-foreground" /></CardHeader><CardContent><div className="text-2xl font-bold">{laboratories.reduce((sum, lab) => sum + (lab.kapasitas || 0), 0)}</div></CardContent></Card><Card><CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2"><CardTitle className="text-sm font-medium">Active Labs</CardTitle><Building2 className="h-4 w-4 text-muted-foreground" /></CardHeader><CardContent><div className="text-2xl font-bold">{laboratories.filter(lab => lab.is_active).length}</div></CardContent></Card></div><div className="flex gap-4"><div className="flex-1 relative"><Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" /><Input placeholder="Search laboratories..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="pl-9" /></div></div><Card><CardHeader><CardTitle>All Laboratories</CardTitle><CardDescription>Manage laboratory facilities and information</CardDescription></CardHeader><CardContent>{loading ? (<div className="text-center py-8">Loading...</div>) : laboratories.length === 0 ? (<div className="text-center py-8">No laboratories found</div>) : (<Table><TableHeader><TableRow><TableHead>Code</TableHead><TableHead>Name</TableHead><TableHead>Location</TableHead><TableHead>Capacity</TableHead><TableHead>Status</TableHead><TableHead>Actions</TableHead></TableRow></TableHeader><TableBody>{laboratories.map((lab) => (<TableRow key={lab.id}><TableCell className="font-mono">{lab.kode_lab}</TableCell><TableCell className="font-medium">{lab.nama_lab}</TableCell><TableCell><div className="flex items-center gap-1"><MapPin className="h-3 w-3" />{lab.lokasi || '-'}</div></TableCell><TableCell>{lab.kapasitas}</TableCell><TableCell><Badge variant={lab.is_active ? 'default' : 'secondary'}>{lab.is_active ? 'Active' : 'Inactive'}</Badge></TableCell><TableCell><Button variant="outline" size="sm" onClick={() => handleEdit(lab)}><Edit className="h-4 w-4 mr-1" />Edit</Button></TableCell></TableRow>))}</TableBody></Table>)}</CardContent></Card><Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}><DialogContent className="max-w-md"><DialogHeader><DialogTitle>Edit Laboratory</DialogTitle><DialogDescription>Update laboratory information</DialogDescription></DialogHeader><div className="space-y-4"><div><Label htmlFor="kode_lab">Lab Code</Label><Input id="kode_lab" value={formData.kode_lab || ''} onChange={(e) => setFormData({...formData, kode_lab: e.target.value})} /></div><div><Label htmlFor="nama_lab">Lab Name</Label><Input id="nama_lab" value={formData.nama_lab || ''} onChange={(e) => setFormData({...formData, nama_lab: e.target.value})} /></div><div><Label htmlFor="lokasi">Location</Label><Input id="lokasi" value={formData.lokasi || ''} onChange={(e) => setFormData({...formData, lokasi: e.target.value})} /></div><div><Label htmlFor="kapasitas">Capacity</Label><Input id="kapasitas" type="number" value={formData.kapasitas || ''} onChange={(e) => setFormData({...formData, kapasitas: parseInt(e.target.value)})} /></div><div><Label htmlFor="keterangan">Description</Label><Input id="keterangan" value={formData.keterangan || ''} onChange={(e) => setFormData({...formData, keterangan: e.target.value})} /></div><div className="flex items-center gap-2"><input type="checkbox" id="is_active" checked={formData.is_active ?? true} onChange={(e) => setFormData({...formData, is_active: e.target.checked})} /><Label htmlFor="is_active">Active</Label></div><div className="flex justify-end gap-2"><Button variant="outline" onClick={() => setIsEditDialogOpen(false)}>Cancel</Button><Button onClick={handleUpdate}>Save Changes</Button></div></div></DialogContent></Dialog></div>);
}
