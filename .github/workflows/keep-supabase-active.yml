name: Keep Supabase Project Active

on:
  # Jalankan setiap 3 hari (jauh sebelum batas 7 hari Supabase free tier)
  schedule:
    - cron: '0 6 */3 * *'  # Setiap 3 hari pada jam 06:00 UTC

  # Bisa dijalankan manual dari GitHub Actions tab
  workflow_dispatch:

# Izin untuk push commit ke repo (mencegah GitHub menonaktifkan workflow)
permissions:
  contents: write

jobs:
  ping-supabase:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ping Supabase REST API
        id: ping
        run: |
          echo "Pinging Supabase to keep project active..."

          if [ -z "${{ secrets.VITE_SUPABASE_URL }}" ] || [ -z "${{ secrets.VITE_SUPABASE_ANON_KEY }}" ]; then
            echo "ERROR: VITE_SUPABASE_URL atau VITE_SUPABASE_ANON_KEY belum di-set di GitHub Secrets."
            echo "Buka: Settings > Secrets and variables > Actions > New repository secret"
            exit 1
          fi

          # Ping ke tabel 'users' dengan limit 1 (query ringan, valid di Supabase)
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 30 \
            -H "apikey: ${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
            -H "Accept: application/json" \
            "${{ secrets.VITE_SUPABASE_URL }}/rest/v1/users?select=id&limit=1" \
            || echo "000")

          echo "Response code: $response"

          # 200 = OK, 401 = Unauthorized (tapi project masih aktif), 406 = Not Acceptable (project aktif)
          # Yang penting bukan 000 (tidak bisa konek sama sekali)
          if [ "$response" = "000" ]; then
            echo "GAGAL: Tidak bisa terhubung ke Supabase. Cek VITE_SUPABASE_URL di secrets."
            exit 1
          fi

          echo "Berhasil! Supabase aktif (HTTP $response)"
          echo "response_code=$response" >> $GITHUB_OUTPUT

      - name: Update keep-alive timestamp
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          RESPONSE="${{ steps.ping.outputs.response_code }}"

          cat > .github/keep-alive.txt << EOF
          Last ping : $TIMESTAMP
          HTTP response : $RESPONSE
          Status       : Active
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/keep-alive.txt

          # Hanya commit jika ada perubahan (cegah empty commit)
          if git diff --staged --quiet; then
            echo "Tidak ada perubahan, skip commit."
          else
            git commit -m "chore: keep-alive ping $TIMESTAMP [skip ci]"
            git push
            echo "Timestamp diperbarui dan di-push."
          fi

      - name: Summary
        run: |
          echo "================================"
          echo " Supabase Keep-Alive Summary"
          echo "================================"
          echo " Waktu ping : $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo " HTTP Status : ${{ steps.ping.outputs.response_code }}"
          echo " Jadwal     : Setiap 3 hari"
          echo " Batas jeda : 7 hari (Supabase free)"
          echo "================================"
