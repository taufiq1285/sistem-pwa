name: Keep Supabase Project Active

on:
  # Jalankan sering agar jauh dari ambang idle Supabase free
  schedule:
    - cron: '0 */6 * * *' # tiap 6 jam
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: keep-supabase-active
  cancel-in-progress: true

jobs:
  ping-supabase:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate and normalize secrets
        run: |
          BASE_URL="${{ secrets.VITE_SUPABASE_URL }}"
          if [ -z "$BASE_URL" ]; then
            BASE_URL="${{ secrets.SUPABASE_URL }}"
          fi

          SERVICE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          ANON_KEY="${{ secrets.VITE_SUPABASE_ANON_KEY }}"
          if [ -z "$ANON_KEY" ]; then
            ANON_KEY="${{ secrets.SUPABASE_ANON_KEY }}"
          fi

          if [ -z "$BASE_URL" ]; then
            echo "ERROR: Secret URL belum ada. Gunakan VITE_SUPABASE_URL atau SUPABASE_URL"
            exit 1
          fi

          if [ -z "$SERVICE_KEY" ] && [ -z "$ANON_KEY" ]; then
            echo "ERROR: Secret key belum ada. Gunakan SUPABASE_SERVICE_ROLE_KEY atau VITE_SUPABASE_ANON_KEY/SUPABASE_ANON_KEY"
            exit 1
          fi

          # Hilangkan trailing slash untuk hindari URL double slash
          BASE_URL="${BASE_URL%/}"

          echo "BASE_URL=$BASE_URL" >> $GITHUB_ENV
          echo "SERVICE_KEY=$SERVICE_KEY" >> $GITHUB_ENV
          echo "ANON_KEY=$ANON_KEY" >> $GITHUB_ENV

      - name: Ping Supabase database activity
        id: ping
        run: |
          BASE_URL="$BASE_URL"

          if [ -n "$SERVICE_KEY" ]; then
            API_KEY="$SERVICE_KEY"
            KEY_TYPE="service_role"
          else
            API_KEY="$ANON_KEY"
            KEY_TYPE="anon"
          fi

          echo "Using key type: $KEY_TYPE"

          # Berdasarkan hasil RLS terbaru:
          # - mata_kuliah punya SELECT policy paling longgar (qual=true)
          # - jadwal_praktikum juga kandidat kuat untuk aktivitas akademik inti
          # - tabel kuis/attempt/jawaban/soal sering bergantung auth.uid()/role
          TABLES=(
            "mata_kuliah"
            "jadwal_praktikum"
            "kelas"
            "kuis"
            "attempt_kuis"
            "soal"
            "jawaban"
          )

          SUCCESS_CODE=""
          SUCCESS_TABLE=""
          LAST_ERROR_CODE=""

          for TABLE in "${TABLES[@]}"; do
            CODE=$(curl -s -o /tmp/resp.json -w "%{http_code}" \
              --max-time 40 \
              -H "apikey: $API_KEY" \
              -H "Authorization: Bearer $API_KEY" \
              -H "Accept: application/json" \
              "$BASE_URL/rest/v1/$TABLE?select=id&limit=1" \
              || echo "000")

            echo "Table '$TABLE' => HTTP $CODE"

            # Sukses query data (aktivitas DB nyata)
            if [ "$CODE" = "200" ] || [ "$CODE" = "206" ]; then
              SUCCESS_CODE="$CODE"
              SUCCESS_TABLE="$TABLE"
              break
            fi

            # Jangan fail cepat untuk 401/403/404; lanjut ke tabel lain
            LAST_ERROR_CODE="$CODE"
          done

          if [ -z "$SUCCESS_TABLE" ]; then
            echo "GAGAL: Tidak ada query tabel yang sukses (200/206)."
            echo "Last observed HTTP code: $LAST_ERROR_CODE"
            echo "Tip: cek nama tabel via SQL: SELECT tablename FROM pg_tables WHERE schemaname='public' ORDER BY tablename;"
            exit 1
          fi

          echo "SUKSES: Aktivitas DB tercatat dari tabel '$SUCCESS_TABLE' (HTTP $SUCCESS_CODE)"
          echo "response_code=$SUCCESS_CODE" >> $GITHUB_OUTPUT
          echo "table_name=$SUCCESS_TABLE" >> $GITHUB_OUTPUT
          echo "key_type=$KEY_TYPE" >> $GITHUB_OUTPUT

      - name: Monthly heartbeat commit (prevent workflow auto-disable)
        run: |
          DAY_UTC=$(date -u '+%d')

          # Commit hanya tanggal 1 setiap bulan untuk minim noise
          if [ "$DAY_UTC" != "01" ]; then
            echo "Bukan tanggal 1 UTC, skip heartbeat commit."
            exit 0
          fi

          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')

          cat > .github/keep-alive.txt << EOF
          Last ping      : $TIMESTAMP
          Table success  : ${{ steps.ping.outputs.table_name }}
          HTTP response  : ${{ steps.ping.outputs.response_code }}
          Key type       : ${{ steps.ping.outputs.key_type }}
          Status         : Active
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/keep-alive.txt

          if git diff --staged --quiet; then
            echo "Tidak ada perubahan heartbeat, skip commit."
          else
            git commit -m "chore: monthly keep-alive heartbeat $TIMESTAMP [skip ci]"
            git push
            echo "Heartbeat bulanan berhasil di-push."
          fi

      - name: Summary
        run: |
          echo "================================"
          echo " Supabase Keep-Alive Summary"
          echo "================================"
          echo " Waktu ping  : $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo " Key type    : ${{ steps.ping.outputs.key_type }}"
          echo " Tabel sukses: ${{ steps.ping.outputs.table_name }}"
          echo " HTTP status : ${{ steps.ping.outputs.response_code }}"
          echo " Jadwal      : Tiap 6 jam"
          echo " Query       : select=id&limit=1"
          echo "================================"
